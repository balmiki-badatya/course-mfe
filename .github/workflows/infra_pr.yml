name: Infrastructure pr workflow
on:
  pull_request:
    branches:
      - main
    paths:
      - devops/**
permissions:
  id-token: write   # This is required for requesting the JWT
  contents: read 
jobs:
  infra_pr_checks:
    runs-on: ubuntu-latest
    name: Course MFE infra checks on PR
    steps:
      - name: Checkout repo
        uses: actions/checkout@v5
        with:
          path: devops
      - name: Setup terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.5.7"
      - name: Authenticate with AWS OIDC
        uses: aws-actions/configure-aws-credentials@v5.1.0
        with:
          aws-region: ${secrets.AWS_REGION}
          role-to-assume: ${secrets.AWS_REGION}
        continue-on-error: false
      - name: Verify OIDC Authenticate
        run: |
          aws sts get-caller-identity
        continue-on-error: false
      - name: Initialize terraform
        run: |
          ls -lrt
          echo "Initializing Terraform"
          terraform init -backend-config="variables/dev/dev.backend.tfvars"
      - name: Terraform format checks
        run: |
          echo "Checking if terraform code is formatted"
          terraform fmt -recursive -check
      - name: Validate terraform code
        run: | 
          echo "Validating terraform code"
          terraform validate -var-file="variables/dev/dev.tfvars"